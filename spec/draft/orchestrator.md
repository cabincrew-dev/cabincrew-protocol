# CabinCrew Orchestrator Specification
Version: draft

The Orchestrator is the authoritative state machine of the CabinCrew Protocol. It coordinates Engines, evaluates governance policies, interacts with Gateways, manages artifacts, enforces plan-token integrity, invokes approval workflows, and generates audit events. This document defines the normative behavior of the Orchestrator.

## 1. Responsibilities of the Orchestrator

The Orchestrator is responsible for:

- preparing execution environments
- launching engines in correct modes
- validating artifacts and receipts
- generating and verifying plan-tokens
- performing preflight checks (OPA and ONNX)
- invoking human approval flows when required
- executing take-off operations safely
- interacting with MCP and LLM gateways
- producing audit events for every transition
- ensuring deterministic and restartable workflows

It acts as the root of trust within the system.

---

## 2. Workflow Lifecycle

A CabinCrew workflow consists of the following stages:

1. **Flight-Plan**  
   Engine generates intent.
2. **Preflight Governance**  
   OPA/ONNX evaluate the artifacts.
3. **Optional Approval**  
   Human decision required for risky changes.
4. **Take-Off**  
   Engine executes the validated plan.
5. **Audit Recording**  
   Every step emits audit events.
6. **Completion**  
   Workflow ends or continues to next step.

The Orchestrator must ensure that these stages occur in order and that no stage is skipped.

---

## 3. Environment Preparation

Before launching an engine, the Orchestrator must:

- create an isolated workspace
- create a fresh artifacts directory
- create a temp directory
- set environment variables:  
  - `CABINCREW_WORKSPACE`  
  - `CABINCREW_ARTIFACTS_DIR`  
  - `CABINCREW_TEMP_DIR`  
  - `CABINCREW_MODE`

The Orchestrator must guarantee that no state leaks between runs unless explicitly defined.

---

## 4. Launching Engines

### 4.1 Flight-Plan Mode

The Orchestrator must:

- pass structured input to the engine  
- enforce no workspace mutation  
- capture the engine receipt  
- validate the receipt and artifact structure  
- generate a plan-token from artifact hashes  
- emit an audit event

### 4.2 Take-Off Mode

The Orchestrator must:

- verify plan-token integrity  
- restore state artifacts if required  
- pass structured input to the engine  
- allow controlled side effects  
- capture and validate engine receipt  
- emit an audit event

If the plan-token does not match, take-off must be denied.

---

## 5. Plan-Token Binding

Plan-tokens ensure that:

- take-off corresponds to an approved plan
- artifacts were not modified between phases
- workflows remain reproducible across restarts

A plan-token is generated by hashing all artifact metadata and roles produced during flight-plan.

The Orchestrator must:

- store the plan-token securely  
- recompute and compare it before take-off  
- halt the workflow if the token does not match  

---

## 6. Preflight Governance

After flight-plan completes, the Orchestrator must perform preflight checks using:

- OPA policies
- ONNX classifiers
- Rule-based evaluation

Possible outcomes:

- **allow** → continue to take-off  
- **warn** → record warning, continue  
- **deny** → halt workflow  
- **require_approval** → pause workflow and escalate  

All preflight outcomes must generate audit events.

---

## 7. Human Approval Flow

If governance requires escalation:

- The Orchestrator must pause deterministically.
- It must generate an `ApprovalRequest`.
- It must wait for an `ApprovalResponse`.
- Approval must be bound to the plan-token.
- Audit events must record all decisions.

The workflow may resume only after successful approval.

---

## 8. Interaction with Gateways

Gateways mediate all external interactions. The Orchestrator must:

- route all engine and agent-generated requests through MCP Gateway
- route all LLM interactions through LLM Gateway
- enforce gateway decisions (allow, warn, deny, require_approval)
- record all gateway evaluations in audit logs

Gateways must never be bypassed.

---

## 9. Artifact Validation

The Orchestrator must verify:

- artifact directory structure  
- validity of artifact.json schemas  
- completeness of referenced body files  
- integrity of content hashes  
- role correctness (evidence, state, log)  

Invalid artifacts must cause workflow failure.

---

## 10. Audit Logging

The Orchestrator must emit audit events for:

- engine launch  
- engine completion  
- governance decisions  
- approval requests and responses  
- gateway evaluations  
- plan-token creation  
- plan-token verification  
- take-off execution  
- workflow completion  

Audit events must conform to audit-event.schema.json.

---

## 11. Restart and Resume Behavior

The Orchestrator must be designed to survive restarts using durable state persistence.

### 11.1 Persistence Requirements

The Orchestrator must persist:

- **WorkflowStateRecord**: Complete workflow state including:
  - Current state and plan-token hash
  - Execution history (completed/pending steps)
  - Approval records with plan-token binding
  - Artifact records with SHA256 hashes
  - Policy evaluation results
  - ISO 8601 timestamps (created_at, updated_at)

- **WAL (Write-Ahead Log)**: Append-only log of all state transitions:
  - `workflow_started` - Initial state with plan-token hash
  - `step_started` / `step_completed` - Step execution lifecycle
  - `approval_requested` / `approval_received` - Approval workflow
  - `artifact_created` - Artifact production
  - `policy_evaluated` - Policy decision
  - `workflow_completed` / `workflow_failed` - Terminal states

Each WAL entry includes:
- Monotonic sequence number
- ISO 8601 timestamp
- Workflow ID
- Entry type and data
- SHA256 checksum for integrity

### 11.2 Recovery Semantics

On restart, the Orchestrator must:

1. **Load WAL entries** in sequence order
2. **Rebuild WorkflowStateRecord** by replaying entries
3. **Verify checksums** to detect corruption
4. **Resume from last completed step**
5. **Validate plan-token integrity**
6. **Verify artifact hashes** match records
7. **Restore approval state** (pending approvals remain paused)

If state is inconsistent or corrupted, workflow must halt with audit event.

---

## 12. Error Handling

The Orchestrator must stop execution when:

- engine receipts are malformed  
- artifacts fail validation  
- plan-token mismatches occur  
- governance denies continuation  
- approvals are rejected  
- gateways deny access  

It must record all errors in audit logs.

---

## 13. Summary

The Orchestrator is the authoritative component that ensures the CabinCrew Protocol remains safe, deterministic, auditable, and governable. It coordinates engines, enforces governance, manages artifacts, validates integrity, directs gateways, handles human approvals, and drives workflows to completion.
