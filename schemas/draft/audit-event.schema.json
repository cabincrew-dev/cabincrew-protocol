{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "AuditEvent",
    "version": "2025-02-01-draft",
    "description": "Canonical schema for all audit log events generated by CabinCrew orchestrator, engines, gateways, and approval systems.",
    "type": "object",
    "properties": {
        "event_id": {
            "type": "string",
            "description": "Unique identifier for this audit event."
        },
        "timestamp": {
            "type": "string",
            "description": "RFC3339 timestamp of when the event occurred."
        },
        "event_type": {
            "type": "string",
            "description": "Free-form event category (e.g. 'engine.run', 'preflight.decision', 'approval.request', 'plan-token.created', 'artifact.integrity_failed')."
        },
        "workflow": {
            "type": "object",
            "description": "Information about the workflow step that produced this event.",
            "properties": {
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "mode": {
                    "type": "string"
                }
            }
        },
        "engine": {
            "type": "object",
            "description": "Engine metadata when event relates to an engine run.",
            "properties": {
                "engine_id": {
                    "type": "string"
                },
                "receipt_id": {
                    "type": "string"
                },
                "status": {
                    "type": "string"
                },
                "error": {
                    "type": "string"
                }
            }
        },
        "plan_token": {
            "type": "object",
            "description": "Embedded plan-token if event concerns plan creation or verification.",
            "$ref": "plan-token.schema.json#"
        },
        "artifacts": {
            "type": "array",
            "description": "List of artifact metadata when the event involves integrity checks or evidence submission.",
            "items": {
                "type": "object",
                "properties": {
                    "name": {
                        "type": "string"
                    },
                    "role": {
                        "type": "string"
                    },
                    "path": {
                        "type": "string"
                    },
                    "hash": {
                        "type": "string"
                    },
                    "size": {
                        "type": "number"
                    }
                }
            }
        },
        "policy": {
            "type": "object",
            "description": "OPA / ONNX evaluation results when event relates to preflight or gateway checks.",
            "properties": {
                "decision": {
                    "type": "string"
                },
                "violations": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "warnings": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "engine": {
                    "type": "string",
                    "description": "Name of policy engine used (e.g. 'OPA', 'ONNX')."
                }
            }
        },
        "approval": {
            "type": "object",
            "description": "Human-in-the-loop approval request or response.",
            "properties": {
                "approval_id": {
                    "type": "string"
                },
                "required_role": {
                    "type": "string"
                },
                "approved": {
                    "type": "boolean"
                },
                "approver": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                }
            }
        },
        "integrity_check": {
            "type": "object",
            "description": "Integrity verification results for plan-token and artifacts.",
            "properties": {
                "expected_plan_token": {
                    "type": "string"
                },
                "actual_plan_token": {
                    "type": "string"
                },
                "plan_token_match": {
                    "type": "boolean"
                },
                "artifacts_match": {
                    "type": "boolean"
                },
                "differences": {
                    "type": "array",
                    "description": "Artifact names that failed integrity verification.",
                    "items": {
                        "type": "string"
                    }
                }
            }
        },
        "gateway": {
            "type": "object",
            "description": "Audit information from LLM or MCP gateways.",
            "properties": {
                "gateway_type": {
                    "type": "string"
                },
                "request_id": {
                    "type": "string"
                },
                "model": {
                    "type": "string"
                },
                "tool": {
                    "type": "string"
                },
                "policy_decision": {
                    "type": "string"
                }
            }
        },
        "message": {
            "type": "string",
            "description": "Human-readable message summarizing the event."
        },
        "severity": {
            "type": "string",
            "description": "Severity of event (e.g. 'info', 'warning', 'error', 'critical').",
            "enum": [
                "debug",
                "info",
                "warning",
                "error",
                "critical"
            ]
        }
    },
    "required": [
        "event_id",
        "timestamp",
        "event_type"
    ],
    "additionalProperties": false
}