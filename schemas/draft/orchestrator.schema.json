{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "orchestrator.schema",
    "type": "object",
    "properties": {
        "PreflightInput": {
            "$ref": "#/definitions/PreflightInput"
        },
        "PreflightOutput": {
            "$ref": "#/definitions/PreflightOutput"
        },
        "ApprovalRequest": {
            "$ref": "#/definitions/ApprovalRequest"
        },
        "ApprovalResponse": {
            "$ref": "#/definitions/ApprovalResponse"
        },
        "WorkflowState": {
            "$ref": "#/definitions/WorkflowState"
        }
    },
    "definitions": {
        "Record<string,any>": {
            "type": "object",
            "additionalProperties": false
        },
        "PreflightEvidence": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "path": {
                    "type": "string"
                },
                "hash": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "hash",
                "name",
                "path"
            ]
        },
        "PlanToken": {
            "description": "Cryptographic binding between a flight-plan and its subsequent take-off.\nDefined in schemas/draft/plan-token.schema.json",
            "type": "object",
            "properties": {
                "token": {
                    "description": "Primary plan token identifier, e.g. SHA256 over all plan artifacts + context.",
                    "type": "string"
                },
                "artifacts": {
                    "description": "Per-artifact hashes that contributed to this plan token.",
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/PlanArtifactHash"
                    }
                },
                "engine_id": {
                    "description": "Engine identity that produced this plan.",
                    "type": "string"
                },
                "protocol_version": {
                    "description": "Engine protocol version used when this plan was produced.",
                    "type": "string"
                },
                "workspace_hash": {
                    "description": "Hash of the workspace state when the plan was created.",
                    "type": "string"
                },
                "created_at": {
                    "description": "Timestamp when the plan was created (RFC3339).",
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "artifacts",
                "created_at",
                "engine_id",
                "protocol_version",
                "token",
                "workspace_hash"
            ]
        },
        "PlanArtifactHash": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "hash": {
                    "type": "string"
                },
                "size": {
                    "type": "number"
                }
            },
            "additionalProperties": false,
            "required": [
                "hash",
                "name"
            ]
        },
        "PreflightInput": {
            "type": "object",
            "properties": {
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "mode": {
                    "enum": [
                        "flight-plan",
                        "take-off"
                    ],
                    "type": "string"
                },
                "engine_output": {
                    "$ref": "#/definitions/Record<string,any>"
                },
                "evidence": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/PreflightEvidence"
                    }
                },
                "context": {
                    "$ref": "#/definitions/Record<string,any>"
                },
                "plan_token": {
                    "description": "Cryptographic binding between a flight-plan and its subsequent take-off.\nDefined in schemas/draft/plan-token.schema.json",
                    "$ref": "#/definitions/PlanToken"
                }
            },
            "additionalProperties": false,
            "required": [
                "engine_output",
                "mode",
                "step_id",
                "workflow_id"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        },
        "PreflightRequires": {
            "type": "object",
            "properties": {
                "role": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                }
            },
            "additionalProperties": false
        },
        "PreflightOutput": {
            "type": "object",
            "properties": {
                "decision": {
                    "enum": [
                        "ALLOW",
                        "DENY",
                        "REQUIRE_APPROVAL",
                        "WARN"
                    ],
                    "type": "string"
                },
                "violations": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "warnings": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "requires": {
                    "$ref": "#/definitions/PreflightRequires"
                }
            },
            "additionalProperties": false,
            "required": [
                "decision"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        },
        "ApprovalRequest": {
            "type": "object",
            "properties": {
                "approval_id": {
                    "type": "string"
                },
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                },
                "required_role": {
                    "type": "string"
                },
                "engine_output": {
                    "$ref": "#/definitions/Record<string,any>"
                },
                "evidence": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/PreflightEvidence"
                    }
                },
                "plan_token_hash": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "approval_id",
                "reason",
                "required_role",
                "step_id",
                "workflow_id"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        },
        "ApprovalResponse": {
            "type": "object",
            "properties": {
                "approval_id": {
                    "type": "string"
                },
                "approved": {
                    "type": "boolean"
                },
                "approver": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                },
                "timestamp": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "approval_id",
                "approved"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        },
        "WorkflowState": {
            "type": "object",
            "properties": {
                "state": {
                    "enum": [
                        "APPROVED",
                        "COMPLETED",
                        "FAILED",
                        "INIT",
                        "PLAN_RUNNING",
                        "PRE_FLIGHT_RUNNING",
                        "TAKEOFF_RUNNING",
                        "WAITING_APPROVAL"
                    ],
                    "type": "string"
                },
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "last_decision": {
                    "type": "string"
                },
                "plan_token_hash": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "state"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        }
    }
}