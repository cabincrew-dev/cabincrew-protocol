{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Orchestrator",
    "version": "2025-02-01-draft",
    "description": "Orchestrator request/response structures, including preflight, approval, workflow state and plan-token binding.",
    "type": "object",
    "properties": {
        "preflight_input": {
            "type": "object",
            "description": "Input given to the preflight (policy) stage.",
            "properties": {
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "mode": {
                    "type": "string",
                    "description": "flight-plan or take-off"
                },
                "engine_output": {
                    "type": "object",
                    "description": "Raw EngineOutput as emitted by the engine.",
                    "additionalProperties": true
                },
                "evidence": {
                    "type": "array",
                    "description": "Subset of artifacts with role=evidence extracted from EngineOutput.",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {
                                "type": "string"
                            },
                            "path": {
                                "type": "string"
                            },
                            "hash": {
                                "type": "string"
                            }
                        },
                        "required": [
                            "name",
                            "path",
                            "hash"
                        ]
                    }
                },
                "context": {
                    "type": "object",
                    "description": "Opaque contextual information from prior workflow steps."
                },
                "plan_token": {
                    "$ref": "plan-token.schema.json#",
                    "description": "Plan token object when evaluating take-off, or when validating a newly created plan."
                }
            },
            "required": [
                "workflow_id",
                "step_id",
                "mode",
                "engine_output"
            ]
        },
        "preflight_output": {
            "type": "object",
            "description": "Unified decision structure emitted after OPA/ONNX evaluation.",
            "properties": {
                "decision": {
                    "type": "string",
                    "enum": [
                        "ALLOW",
                        "WARN",
                        "REQUIRE_APPROVAL",
                        "DENY"
                    ]
                },
                "violations": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "warnings": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "requires": {
                    "type": "object",
                    "description": "Present when decision = REQUIRE_APPROVAL.",
                    "properties": {
                        "role": {
                            "type": "string"
                        },
                        "reason": {
                            "type": "string"
                        }
                    }
                }
            },
            "required": [
                "decision"
            ]
        },
        "approval_request": {
            "type": "object",
            "description": "Approval packet sent to a human or approval system when decision = REQUIRE_APPROVAL.",
            "properties": {
                "approval_id": {
                    "type": "string"
                },
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                },
                "required_role": {
                    "type": "string"
                },
                "engine_output": {
                    "type": "object",
                    "description": "EngineOutput receipt.",
                    "additionalProperties": true
                },
                "evidence": {
                    "type": "array",
                    "description": "Evidence artifacts that influenced the decision.",
                    "items": {
                        "type": "object",
                        "properties": {
                            "name": {
                                "type": "string"
                            },
                            "path": {
                                "type": "string"
                            },
                            "hash": {
                                "type": "string"
                            }
                        },
                        "required": [
                            "name",
                            "path",
                            "hash"
                        ]
                    }
                },
                "plan_token_hash": {
                    "type": "string",
                    "description": "Hash of the plan-token object used to bind this approval to a specific plan (optional for flight-plan stage, required for take-off approvals)."
                }
            },
            "required": [
                "approval_id",
                "workflow_id",
                "step_id",
                "reason",
                "required_role"
            ]
        },
        "approval_response": {
            "type": "object",
            "description": "Response from the human approver or approval system.",
            "properties": {
                "approval_id": {
                    "type": "string"
                },
                "approved": {
                    "type": "boolean"
                },
                "approver": {
                    "type": "string"
                },
                "reason": {
                    "type": "string"
                },
                "timestamp": {
                    "type": "string"
                }
            },
            "required": [
                "approval_id",
                "approved"
            ]
        },
        "workflow_state": {
            "type": "object",
            "description": "State machine snapshot for the orchestrator.",
            "properties": {
                "state": {
                    "type": "string",
                    "enum": [
                        "INIT",
                        "PLAN_RUNNING",
                        "PRE_FLIGHT_RUNNING",
                        "WAITING_APPROVAL",
                        "APPROVED",
                        "TAKEOFF_RUNNING",
                        "COMPLETED",
                        "FAILED"
                    ]
                },
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                },
                "last_decision": {
                    "type": "string",
                    "enum": [
                        "ALLOW",
                        "WARN",
                        "REQUIRE_APPROVAL",
                        "DENY"
                    ],
                    "description": "Last preflight policy decision."
                },
                "plan_token_hash": {
                    "type": "string",
                    "description": "If a flight-plan has been accepted, this stores the hash of its plan-token for later take-off validation."
                }
            },
            "required": [
                "state"
            ]
        }
    },
    "additionalProperties": false
}