{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "engine.schema",
    "type": "object",
    "properties": {
        "EngineInput": {
            "$ref": "#/definitions/EngineInput"
        },
        "EngineOutput": {
            "$ref": "#/definitions/EngineOutput"
        }
    },
    "definitions": {
        "EngineMeta": {
            "type": "object",
            "properties": {
                "workflow_id": {
                    "type": "string"
                },
                "step_id": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "step_id",
                "workflow_id"
            ]
        },
        "AnyMap": {
            "type": "object",
            "additionalProperties": {}
        },
        "EngineOrchestrator": {
            "type": "object",
            "properties": {
                "run_index": {
                    "type": "number"
                },
                "workspace_hash": {
                    "type": "string"
                },
                "artifacts_salt": {
                    "type": "string"
                }
            },
            "additionalProperties": false
        },
        "EngineInput": {
            "description": "Input delivered via STDIN or CABINCREW_INPUT_FILE.\nDefined in schemas/draft/engine.schema.json",
            "type": "object",
            "properties": {
                "protocol_version": {
                    "type": "string"
                },
                "mode": {
                    "description": "Execution mode: 'flight-plan' or 'take-off'.",
                    "type": "string"
                },
                "meta": {
                    "$ref": "#/definitions/EngineMeta"
                },
                "config": {
                    "$ref": "#/definitions/AnyMap"
                },
                "secrets": {
                    "$ref": "#/definitions/AnyMap"
                },
                "allowed_secrets": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "context": {
                    "$ref": "#/definitions/AnyMap"
                },
                "orchestrator": {
                    "$ref": "#/definitions/EngineOrchestrator"
                },
                "expected_plan_token": {
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "meta",
                "mode",
                "protocol_version"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        },
        "EngineArtifact": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "role": {
                    "type": "string"
                },
                "path": {
                    "type": "string"
                },
                "hash": {
                    "type": "string"
                },
                "size": {
                    "type": "number"
                }
            },
            "additionalProperties": false,
            "required": [
                "hash",
                "name",
                "path",
                "role"
            ]
        },
        "EngineMetric": {
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "value": {
                    "type": "number"
                },
                "tags": {
                    "$ref": "#/definitions/AnyMap"
                }
            },
            "additionalProperties": false,
            "required": [
                "name",
                "value"
            ]
        },
        "EngineOutput": {
            "description": "Output delivered via STDOUT or CABINCREW_OUTPUT_FILE.\nDefined in schemas/draft/engine.schema.json",
            "type": "object",
            "properties": {
                "protocol_version": {
                    "type": "string"
                },
                "engine_id": {
                    "type": "string"
                },
                "mode": {
                    "type": "string"
                },
                "receipt_id": {
                    "type": "string"
                },
                "status": {
                    "description": "Execution status: 'success' or 'failure'.",
                    "type": "string"
                },
                "error": {
                    "type": "string"
                },
                "warnings": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "diagnostics": {},
                "artifacts": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/EngineArtifact"
                    }
                },
                "metrics": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/EngineMetric"
                    }
                },
                "plan_token": {
                    "description": "SHA256 hash referencing a plan-token.json file.",
                    "type": "string"
                }
            },
            "additionalProperties": false,
            "required": [
                "engine_id",
                "mode",
                "protocol_version",
                "receipt_id",
                "status"
            ],
            "$schema": "http://json-schema.org/draft-07/schema#"
        }
    }
}